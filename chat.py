from flask import Flask, render_template, request, jsonify
import numpy as np
import os
import csv
import logging
import re
from datetime import datetime
import tensorflow as tf 
import logging 

# Set up logging
logging.basicConfig(level=logging.DEBUG)
# ุชูุธูุงุช ุงููู logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

app = Flask(__name__)


# ุจุงุฑฺฏุฐุงุฑ ูุฏู  
# ุจุงุฑฺฏุฐุงุฑ ูุฏู
model_path = 'mlp_model/mlp_model.keras'
model = tf.keras.models.load_model(model_path) 

# Dictionary to keep track of user state
user_data = {}

# List of valid symptoms
symptom_keywords = {
    "ูพุฑุงุฏุฑุงุฑ": ["ูพุฑุงุฏุฑุงุฑ", "ุงุฏุฑุงุฑ ุฒุงุฏ", "ุงุฏุฑุงุฑ ุจุด ุงุฒ ุญุฏ", "ุฒุงุฏ ุฏุณุชุดู ูโุฑู", "ุฏุณุชุดู ุฑูุชู ุฒุงุฏ", "ุดุจโูุง ุจุฏุงุฑ ูโุดู ุจุฑุง ุงุฏุฑุงุฑ", "ุดุจโูุง ุฒุงุฏ ุจุฏุงุฑ ูโุดู"],
    "ุนุทุด": ["ุนุทุด", "ุชุดูฺฏ", "ุฎู ุชุดููโุงู", "ูุฏุงู ุขุจ ูโุฎูุฑู", "ุฒุงุฏ ุขุจ ูโุฎูุฑู"],
    "ฺฉุงูุด ูุฒู": ["ฺฉุงูุด ูุฒู", "ุงูุช ูุฒู", "ูุฒูู ฺฉู ุดุฏู", "ุจุฏูู ุฏูู ูุฒู ฺฉู ฺฉุฑุฏู", "ูุงฺฏูุงู ูุฒู ฺฉู ฺฉุฑุฏู"],
    "ุถุนู": ["ุถุนู", "ุจโุญุงู", "ุงูุฑฺ ูุฏุงุฑู", "ููุดู ุฎุณุชูโุงู", "ุฎู ุจโุญุงู ุดุฏู"],
    "ูพุฑุฎูุฑ": ["ูพุฑุฎูุฑ", "ุฒุงุฏ ูโุฎูุฑู", "ุงุดุชูุงู ุฒุงุฏ ุดุฏู", "ฺฏุฑุณูฺฏ ูุฏุงูู ุฏุงุฑู"],
    "ุนูููุช ูุงุฑฺ": ["ุนูููุช ูุงุฑฺ", "ุนูููุช ุฏุฑ ูุงุญู ุชูุงุณู", "ุณูุฒุด ุง ุฎุงุฑุด ูุงุญู ุชูุงุณู", "ุจู ูุงูุทุจูุน"],
    "ุชุงุฑ ุฏุฏ": ["ุชุงุฑ ุฏุฏ", "ฺฉุงูุด ูุฏุงู ุฏุฏ", "ฺุดูุงู ุชุงุฑ ูโุจูู", "ุฏุฏู ุฎูุจ ูุณุช", "ฺุฒุง ุฑู ุชุงุฑ ูโุจูู"],
    "ุฎุงุฑุด": ["ุฎุงุฑุด", "ุฎุดฺฉ ูพูุณุช", "ุฎุงุฑุด ุจุฏู", "ูพูุณุชู ูโุฎุงุฑู", "ูพูุณุชู ุฎุดฺฉ ุดุฏู"],
    "ุนุตุจุงูุช": ["ุนุตุจุงูุช", "ุชุญุฑฺฉโูพุฐุฑ", "ุฒูุฏ ุงุฒ ฺฉูุฑู ุฏุฑ ูโุฑู", "ุฒูุฏ ุนุตุจ ูโุดู", "ฺฉูุชุฑู ุงุญุณุงุณุงุช ุณุฎุช ุดุฏู"],
    "ุชุฃุฎุฑ ุฏุฑ ุจูุจูุฏ": ["ุชุฃุฎุฑ ุฏุฑ ุจูุจูุฏ", "ุฒุฎูโูุงู ุฏุฑ ุฎูุจ ูโุดู", "ุฒุฎูโูุงู ุจุงู ูโูููู", "ุฎูุจ ูุดุฏู ุฒุฎูโูุง"],
    "ููุฌ ุฌุฒุฆ": ["ููุฌ ุฌุฒุฆ", "ุถุนู ุนุถูุงู", "ุนุถูุงุชู ูุงุชูุงู ุดุฏู", "ุจุฎุด ุงุฒ ุจุฏูู ุฎูุจ ฺฉุงุฑ ููโฺฉูู"],
    "ุฏุฑุฏ ุนุถูุงู": ["ุฏุฑุฏ ุนุถูุงู", "ฺฉุดุฏฺฏ ุนุถูุงุช", "ุจุฏูู ุฏุฑุฏ ูโฺฉูู", "ุนุถูุงุชู ูโฺฉุดู"],
    "ุณูุช ุนุถูุงุช": ["ุณูุช ุนุถูุงุช", "ุฎุดฺฉ ุนุถูุงุช", "ุนุถูุงุชู ฺฏุฑูุชู", "ุงูุนุทุงู ูุฏุงุฑู"],
    "ุฑุฒุด ูู": ["ุฑุฒุด ูู", "ฺฉูโูพุดุช ุดุฏู ูู", "ูููุงู ูุฑุฒู"],
    "ฺุงู": ["ฺุงู", "ุงุถุงูู ูุฒู", "ุฎู ฺุงู ุดุฏู", "ูุฒูู ุฑูุชู ุจุงูุง"]
}

positive_keywords = [
    "ุจูู", "ุขุฑู", "ุงุฑู", "ุฏุงุฑู", "ุจุนุถ ููุชุง", "ฺฏุงู", "ุงฺฉุซุฑุง", "ููุดู", 
    "ูฺฉูู", "ุงุญุณุงุณ ูฺฉูู", "ุดุฏู", "ูพุด ูุงุฏ", "ุฒุงุฏ", "ุชุง ุญุฏูุฏ", "ุฏุฑฺฏุฑู",
    "ุจุฑุงู ูพุด ุงููุฏู", "ูุดุงูุฏู ฺฉุฑุฏู", "ุฏุฏู", "ูโ ุดูู", "ุงุญุณุงุณ ูโฺฉูู", "ุฏฺุงุฑู", "ูุณุชู"
]

negative_keywords = [
    "ูู", "ุฎุฑ", "ูุฏุงุฑู", "ููโฺฉูู", "ูุณุชู", "ููโุดูู", "ููโุฎูุฑู", "ููโุฑู", 
    "ุงุตูุง", "ูุฏุงุดุชู", "ูุฑฺฏุฒ", "ฺฉู", "ุฎู ฺฉู", "ูุงุฏุฑู", "ุจู ูุฏุฑุช", "ุชูุฑุจุงู ูู"
]

# FAQ responses in Persian
faq_responses = {
    "ุนูุงุฆู ุฏุงุจุช": 
    "ุจุฑุฎ ุนูุงุฆู ุฏุงุจุช ุนุจุงุฑุชูุฏ ุงุฒ: ูพุฑุงุฏุฑุงุฑุ ุชุดูฺฏ ุฒุงุฏุ ฺฉุงูุด ูุฒู ูุงฺฏูุงู",
    
    "ุฏุงุจุช ฺุณุช": 
    "ุฏุงุจุช ฺฉ ุจูุงุฑ ูุฒูู ุงุณุช ฺฉู ุฏุฑ ุขู ุณุทุญ ููุฏ ุฎูู (ฺฏููฺฉุฒ) ุฏุฑ ุจุฏู ุงูุฒุงุด ูโุงุจุฏ",

    "ุนูุงุฆู ุฏุงุจุช ฺุณุช": 
    "ุจุฑุฎ ุนูุงุฆู ุฏุงุจุช ุนุจุงุฑุชูุฏ ุงุฒ: ูพุฑุงุฏุฑุงุฑุ ุชุดูฺฏ ุฒุงุฏุ ฺฉุงูุด ูุฒู ูุงฺฏูุงู",

    "ฺฺฏููู ุงุฒ ุฏุงุจุช ูพุดฺฏุฑ ฺฉูู": 
    "ุจุง ุชุบุฐู ุณุงููุ ูุฑุฒุด ููุธูุ ฺฉูุชุฑู ูุฒู ู ฺฺฉุงูพโูุง ููุธู",

    "ุนูุงุฆู ุฏุงุจุช": 
    "ุจุฑุฎ ุนูุงุฆู ุฏุงุจุช ุนุจุงุฑุชูุฏ ุงุฒ: ูพุฑุงุฏุฑุงุฑุ ุชุดูฺฏ ุฒุงุฏุ ฺฉุงูุด ูุฒู ูุงฺฏูุงู",

    "ูพุดฺฏุฑ ุงุฒ ุฏุงุจุช":
    "ูพุดฺฏุฑ ุงุฒ ุฏุงุจุช ูุงุฒููุฏ ุชุบุฐู ุณุงูู ู ูุฑุฒุด ููุธู ุงุณุช . ููฺูู ฺฺฉุงูพ ูุง ููุธู ู ฺฉูุชุฑู ูุฒู ูุฒ ูุชูุงูุฏ ุจู ูพุดฺฏุฑ ุงุฒ ุฏุงุจุช ฺฉูฺฉ ฺฉูุฏ.",

    "ุฏุฑูุงู ุฏุงุจุช ฺฺฏููู ุงุณุช": 
    "ุฏุฑูุงู ุฏุงุจุช ุดุงูู ุฑฺู ุบุฐุง ููุงุณุจุ ูุฑุฒุดุ ูุตุฑู ุฏุงุฑู ุง ุงูุณููู",

    "ฺู ุนูุงุฆู ูุดุงูโุฏููุฏู ุฏุงุจุช ูุณุชูุฏ" : 
    "ูพุฑุงุฏุฑุงุฑุ ุชุดูฺฏ ุฒุงุฏุ ฺฉุงูุด ูุฒูุ ุฎุณุชฺฏุ ุชุงุฑ ุฏุฏุ ุฏุฑ ุฎูุจ ุดุฏู ุฒุฎูโูุง ู ุนูููุชโูุง ูฺฉุฑุฑ ุงุฒ ุฌููู ุนูุงุฆู ุฏุงุจุช ูุณุชูุฏ.",

    "ุฏุงุจุช ููุน ฑ ฺุณุช" : 
    "ุฏุงุจุช ููุน ฑ ฺฉ ุจูุงุฑ ุฎูุฏุงูู ุงุณุช ฺฉู ุฏุฑ ุขู ุจุฏู ุณูููโูุง ุชููุฏฺฉููุฏู ุงูุณููู ุฏุฑ ูพุงูฺฉุฑุงุณ ุฑุง ุงุฒ ุจู ูโุจุฑุฏ ู ูุนูููุงู ุฏุฑ ฺฉูุฏฺฉุงู ู ููุฌูุงูุงู ุชุดุฎุต ุฏุงุฏู ูโุดูุฏ.",

    "ุฏุงุจุช ููุน ฺฉ ฺุณุช" : 
    "ุฏุงุจุช ููุน ฑ ฺฉ ุจูุงุฑ ุฎูุฏุงูู ุงุณุช ฺฉู ุฏุฑ ุขู ุจุฏู ุณูููโูุง ุชููุฏฺฉููุฏู ุงูุณููู ุฏุฑ ูพุงูฺฉุฑุงุณ ุฑุง ุงุฒ ุจู ูโุจุฑุฏ ู ูุนูููุงู ุฏุฑ ฺฉูุฏฺฉุงู ู ููุฌูุงูุงู ุชุดุฎุต ุฏุงุฏู ูโุดูุฏ.",

    "ุฏุงุจุช ููุน ฒ ฺุณุช" :
    " ุฏุงุจุช ููุน ฒ ุดุงุนโุชุฑู ููุน ุฏุงุจุช ุงุณุช ฺฉู ูุนูููุงู ุฏุฑ ุงูุฑุงุฏ ุจุฒุฑฺฏโุณุงู ุจุฑูุฒ ูโฺฉูุฏ ู ูุงุด ุงุฒ ููุงููุช ุจุฏู ุจู ุงูุณููู ุง ฺฉุงูุด ุชููุฏ ุขู ุงุณุช.",

    "ุฏุงุจุช ููุน ุฏู ฺุณุช" : 
    "ุฏุงุจุช ููุน ฒ ุดุงุนโุชุฑู ููุน ุฏุงุจุช ุงุณุช ฺฉู ูุนูููุงู ุฏุฑ ุงูุฑุงุฏ ุจุฒุฑฺฏโุณุงู ุจุฑูุฒ ูโฺฉูุฏ ู ูุงุด ุงุฒ ููุงููุช ุจุฏู ุจู ุงูุณููู ุง ฺฉุงูุด ุชููุฏ ุขู ุงุณุช.",

    "ุขุง ุฏุงุจุช ุฏุฑูุงู ุฏุงุฑุฏ" :
    "ุฏุงุจุช ุฏุฑูุงู ูุทุน ูุฏุงุฑุฏุ ุงูุง ุจุง ุชุบุฑ ุณุจฺฉ ุฒูุฏฺฏุ ุฑฺู ุบุฐุง ููุงุณุจุ ุฏุงุฑู ู ุงูุณููู ูโุชูุงู ุขู ุฑุง ฺฉูุชุฑู ฺฉุฑุฏ",

    "ุขุง ุฏุงุจุช ุงุฑุซ ุงุณุช" :
    "ุจููุ ุณุงุจูู ุฎุงููุงุฏฺฏ ฺฉ ุงุฒ ุนูุงูู ุฎุทุฑ ุงุจุชูุง ุจู ุฏุงุจุช ุงุณุชุ ุงูุง ุนูุงูู ูุญุท ูุฒ ุฏุฑ ุจุฑูุฒ ุขู ููุด ุฏุงุฑูุฏ.",

    "ฺฺฏููู ูโุชูุงู ุงุฒ ุฏุงุจุช ูพุดฺฏุฑ ฺฉุฑุฏ" :
    "ุจุง ุชุบุฐู ุณุงููุ ูุฑุฒุด ููุธูุ ุญูุธ ูุฒู ููุงุณุจ ู ฺฺฉุงูพโูุง ุฏูุฑูโุง ูโุชูุงู ุงุฒ ุจุฑูุฒ ุฏุงุจุช ููุน ฒ ุฌููฺฏุฑ ฺฉุฑุฏ.",

    "ููุด ุงูุณููู ุฏุฑ ุจุฏู ฺุณุช" :
    "ุงูุณููู ููุฑููู ุงุณุช ฺฉู ุจู ุงูุชูุงู ฺฏููฺฉุฒ ุงุฒ ุฎูู ุจู ุณูููโูุง ฺฉูฺฉ ูโฺฉูุฏ ุชุง ุงุฒ ุขู ุจู ุนููุงู ุงูุฑฺ ุงุณุชูุงุฏู ฺฉููุฏ.",

    "ุงฺฏุฑ ุฏุงุจุช ฺฉูุชุฑู ูุดูุฏุ ฺู ุนูุงุฑุถ ุฏุงุฑุฏ" :
    "ุนูุงุฑุถ ุฏุงุจุช ุดุงูู ุจูุงุฑโูุง ููุจุ ุขุณุจ ุจู ฺฉููุ ูุดฺฉูุงุช ฺุดูุ ุขุณุจ ุนุตุจ ู ุฒุฎูโูุง ูุฒูู ุงุณุช.",

    "ุฏุงุจุช ุจุงุฑุฏุงุฑ ฺุณุช" :
    "ุฏุงุจุช ุจุงุฑุฏุงุฑ ููุน ุฏุงุจุช ุงุณุช ฺฉู ุจุฑุง ุงููู ุจุงุฑ ุฏุฑ ุฏูุฑุงู ุจุงุฑุฏุงุฑ ุชุดุฎุต ุฏุงุฏู ูโุดูุฏ ู ูุนูููุงู ูพุณ ุงุฒ ุฒุงูุงู ุจุฑุทุฑู ูโุดูุฏ.",

    "ฺฺฏููู ููุฏ ุฎูู ุฑุง ฺฉูุชุฑู ฺฉูู":
    "ุจุง ุฑุนุงุช ุฑฺู ุบุฐุง ุณุงููุ ูุนุงูุช ุจุฏู ููุธูุ ูุตุฑู ุฏุงุฑู ุง ุงูุณููู ู ุงูุฏุงุฒูโฺฏุฑ ููุธู ููุฏ ุฎูู ูโุชูุงู ุขู ุฑุง ฺฉูุชุฑู ฺฉุฑุฏ.",

    "ุขุง ุงูุฑุงุฏ ูุงุบุฑ ูู ุฏุงุจุช ูโฺฏุฑูุฏ" :
    "ุจููุ ฺฏุฑฺู ฺุงู ฺฉ ุงุฒ ุนูุงูู ุฎุทุฑ ุงุณุชุ ุงูุง ุฏุงุจุช ูโุชูุงูุฏ ุฏุฑ ุงูุฑุงุฏ ูุงุบุฑ ูุฒ ุจู ุฏูุงู ฺูุชฺฉ ุง ุฏฺฏุฑ ุนูุงูู ุฑุฎ ุฏูุฏ.",

    "ุขุง ุฏุงุจุช ุจุงุนุซ ุงูุณุฑุฏฺฏ ูโุดูุฏ" :
    "ุงูุฑุงุฏ ูุจุชูุง ุจู ุฏุงุจุช ุจู ุฏูู ูุดุงุฑ ุฑูุงู ุจูุงุฑ ุจุดุชุฑ ุฏุฑ ูุนุฑุถ ุงูุณุฑุฏฺฏ ูุฑุงุฑ ุฏุงุฑูุฏ ู ูุงุฒ ุจู ุญูุงุช ุฑูุญ ุฏุงุฑูุฏ.",

    "ฺู ุบุฐุงูุง ุจุฑุง ุฏุงุจุชโูุง ููุงุณุจ ูุณุชูุฏ" :
    "ุบุฐุงูุง ฺฉูโููุฏุ ฺฉูโฺุฑุจุ ุฏุงุฑุง ูุจุฑ ุจุงูุง ูุงููุฏ ุณุจุฒุฌุงุชุ ุบูุงุช ฺฉุงููุ ฺฏูุดุช ุจุฏูู ฺุฑุจ ู ูุจูุงุช ฺฉูโฺุฑุจ ููุงุณุจ ูุณุชูุฏ.",

    "ุขุง ูโุชูุงู ุงุฒ ุงูุณููู ุทุจุน ุงุณุชูุงุฏู ฺฉุฑุฏ" :
    "ุฏุฑ ุญุงู ุญุงุถุฑ ุงูุณููู ููุฌูุฏ ุฏุฑ ุจุงุฒุงุฑ ุจู ุตูุฑุช ุฏุงุฑู ู ุชููุฏ ุดุฏู ุฏุฑ ุขุฒูุงุดฺฏุงูโูุง ุงุณุช ู ุงูุณููู ุทุจุน ุจุฑุง ุฏุฑูุงู ุงุณุชูุงุฏู ููโุดูุฏ.",

    "ุขุง ุฏุงุจุช ูุงุจู ุจุงุฒฺฏุดุช ุงุณุช" :
    "ุฏุฑ ุจุฑุฎ ููุงุฑุฏ ุฏุงุจุช ููุน ฒ ุจุง ฺฉุงูุด ูุฒู ู ุชุบุฑ ุณุจฺฉ ุฒูุฏฺฏ ููฺฉู ุงุณุช ุจูุจูุฏ ุงุจุฏุ ุงูุง ุจู ูุนู ุฏุฑูุงู ูุทุน ูุณุช.",

    "ฺฺฏููู ุงุฒ ุฒุฎู ูพุง ุฏุงุจุช ุฌููฺฏุฑ ฺฉูู" :
    "ุจุฑุฑุณ ุฑูุฒุงูู ูพุงูุงุ ูพูุดุฏู ฺฉูุด ููุงุณุจุ ุฑุนุงุช ุจูุฏุงุดุช ู ฺฉูุชุฑู ููุฏ ุฎูู ุงุฒ ุฑุงูโูุง ูพุดฺฏุฑ ุงุฒ ุฒุฎู ูพุง ุฏุงุจุช ุงุณุช.",

    "ุขุง ุงุณุชุฑุณ ุฑู ุฏุงุจุช ุชุงุซุฑ ุฏุงุฑุฏ":
    "ุจููุ ุงุณุชุฑุณ ูโุชูุงูุฏ ุจุงุนุซ ุงูุฒุงุด ุณุทุญ ููุฏ ุฎูู ุดูุฏ ู ฺฉูุชุฑู ุฏุงุจุช ุฑุง ุณุฎุชโุชุฑ ฺฉูุฏ.",

    "ฺู ุขุฒูุงุดโูุง ุจุฑุง ุชุดุฎุต ุฏุงุจุช ุงูุฌุงู ูโุดูุฏ" :
    "ุขุฒูุงุด ููุฏ ุฎูู ูุงุดุชุงุ ุขุฒูุงุด HbA1c ู ุชุณุช ุชุญูู ฺฏููฺฉุฒ ุจุฑุง ุชุดุฎุต ุฏุงุจุช ุงุณุชูุงุฏู ูโุดููุฏ.",

    "ุขุง ุฏุงุจุช ูุงุจู ฺฉูุชุฑู ุงุณุช" :
    "ุจููุ ุฏุงุจุช ุจุง ูพุงุด ููุธูุ ุฑุนุงุช ุฑฺู ุบุฐุงุ ูุฑุฒุด ู ูุตุฑู ุฏุงุฑููุง ูุงุจู ฺฉูุชุฑู ุงุณุช ู ุงูุฑุงุฏ ูโุชูุงููุฏ ุฒูุฏฺฏ ุณุงูู ุฏุงุดุชู ุจุงุดูุฏ."
}

@app.route("/")
def home():
    return render_template("index.html")

@app.route("/get_response", methods=["POST"])  
def get_response():  
    user_message = request.form["message"]  
    user_id = request.form.get("user_id")  # ฺฏุฑูุชู ุดูุงุณู ฺฉุงุฑุจุฑ ุจุฑุง ูฺฏูุฏุงุฑ ูุถุนุช  

    # ุงุฌุงุฏ ุณุงุฎุชุงุฑ ุจุฑุง ุฐุฎุฑู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ ุงฺฏุฑ ูููุฒ ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏ  
    if user_id not in user_data:  
        user_data[user_id] = {  
            "age": None,  
            "gender": None,  
            "symptoms": []  
        }  

    print(f"ูุฑูุฏ ฺฉุงุฑุจุฑ: {user_message}")  
    response = user_response(user_message, user_id)  
    return jsonify({"response": response})

# Prediction function
def predict_diabetes(input_data):
    prediction = model.predict(input_data)  
    probability = prediction[0][0] * 100  
    return probability
     
@app.route('/health', methods=['GET'])
def health_check():
    """Health check endpoint"""
    return jsonify({"status": "healthy", "model_loaded": model is not None})

def user_response(user_input, user_id): 
    current_data = user_data[user_id]  
    responses = []

    questions = [    
        "ุขุง ุจุด ุงุฒ ุญุฏ ูุนููู ุงุฏุฑุงุฑ ูโฺฉูุฏุ",  
        "ุขุง ุงุญุณุงุณ ุชุดูฺฏ ูุฏุงูู ุฏุงุฑุฏุ",  
        "ุขุง ฺฉุงูุด ูุฒู ูุงฺฏูุงู ุฏุงุดุชูโุงุฏุ",  
        "ุขุง ุถุนู ุจุฏู ุฏุงุฑุฏุ",  
        "ุขุง ุงุดุชูุง ุดูุง ุจู ุทูุฑ ุบุฑ ุนุงุฏ ุงูุฒุงุด ูพุฏุงฺฉุฑุฏู ุงุณุชุ",  
        "ุขุง ูุจุชูุง ุจู ุนูููุชโูุง ูุงุฑฺ ูุณุชุฏุ",  
        "ุขุง ุชุงุฑ ุฏุฏ ุฏุงุฑุฏุ",  
        "ุขุง ุงุญุณุงุณ ุฎุดฺฉ ู ุง ุฎุงุฑุด ูพูุณุช ุฏุงุฑุฏุ",  
        "ุขุง ุจู ุณุฑุนุช ุนุตุจ ูโุดูุฏุ",  
        "ุขุง ุจูุจูุฏ ุฒุฎูโูุง ุจุฏูุชุงู ุจู ฺฉูุฏ ุตูุฑุช ูโฺฏุฑุฏุ",  
        "ุขุง ููุฌ ุฌุฒุฆ (ุถุนู ุง ฺฉุงูุด ุชูุงูุง ุญุฑฺฉุช ุฏุฑ ฺฉ ุนุถูู ุฎุงุต) ุฏุงุฑุฏุ",  
        "ุขุง ุฏุฑ ุงูุฌุงู ูุนุงูุช ูุง ุฑูุฒูุฑู ุฏุฑ ุนุถูู ุฎุงุต ุงุญุณุงุณ ฺฉุดุฏฺฏ ุง ุฏุฑุฏ ูโฺฉูุฏุ",  
        "ุขุง ุฑุฒุด ูู ุฏุงุฑุฏุ",  
        "ุขุง ุงุถุงูู ูุฒู ุฏุงุฑุฏุ"  
    ]

    user_input_clean = user_input.strip().lower() 

    if user_input_clean in ["ุฎุฏุงุญุงูุธ", "ุฎุฏุงูฺฏูุฏุงุฑ", "ุจุง", "ุฎุฏุงูุธ"]:  
        return "ุงูุฏูุงุฑู ุชููุณุชู ุจุงุดู ฺฉูฺฉุชูู ฺฉูู. ุฎุฏุงูฺฏูุฏุงุฑ " 
    
    if user_input_clean in ["ููููู", "ูููููู", "ุชุดฺฉุฑ", "ูุชุดฺฉุฑู"]:  
        return "ุฎูุงูุด ูฺฉูู. ุงูุฏูุงุฑู ุงู ุงุทูุงุนุงุช ุจุฑุง ุดูุง ููุฏ ุจูุฏู ุจุงุดุฏ. ุขุง ฺฉูฺฉ ุฏฺฏุฑ ุงุฒ ูู ุจุฑ ู ุขุฏุ๐ท" 

    elif current_data.get("waiting_for_more_questions", False):  
        if user_input.strip() in ["ุณูุงู", "ุจูพุฑุณ", "ูพุฑุณุด", "ุจุงุดู", "ุญุชูุง", "ุดุฑูุน ฺฉู", "ุจูพุฑุณ"]:  
            current_data["current_question_index"] = 0  # ุดุฑูุน ุงุฒ ุณูุงู ุงูู  
            return questions[current_data["current_question_index"]]


    # ุจุฑุฑุณ ุณูุงูุงุช ูุชุฏุงูู
    cleaned_input = user_input.strip().replace("ุ", "").replace("?", "").lower()
    for faq_question in faq_responses:
        if faq_question in cleaned_input:
            return faq_responses[faq_question]



    # ุฌูุณุช
    if current_data["gender"] is None:
        if any(g in user_input_clean for g in ["ุฎุงูู", "ุฒู", "ุฏุฎุชุฑ", "ูููุซ"]):
            current_data["gender"] = 0
        elif any(g in user_input_clean for g in ["ุขูุง", "ูุฑุฏ", "ูพุณุฑ", "ูุฐฺฉุฑ"]):
            current_data["gender"] = 1


    # ุณู
    age_match = re.search(r'(\d+)\s*ุณุงู', user_input)
    if age_match and current_data["age"] is None:
        current_data["age"] = int(age_match.group(1))
    elif current_data["age"] is None:
        standalone_age_match = re.search(r'^\d+$', user_input_clean)
        if standalone_age_match:
            current_data["age"] = int(standalone_age_match.group(0))
        else:
            return "ูุทูุงู ุณู ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ." 

    # ุจุฑุฑุณ ุนูุงุฆู ุงุฒ ุทุฑู ุนุจุงุฑุชโูุง ูุชููุน


    symptoms_in_input = []
    for symptom, keywords in symptom_keywords.items():
        for keyword in keywords:
            pattern = re.escape(keyword)
            if re.search(pattern, user_input_clean) and symptom not in current_data["symptoms"]:
                symptoms_in_input.append(symptom)
                break

    if symptoms_in_input:
        current_data["symptoms"].extend(symptoms_in_input)

    # ูพุดโุจู ุงููู
    if current_data["age"] is not None and current_data["gender"] is not None:
        if not current_data.get("prediction_done", False):
            current_data["prediction_done"] = True
            prediction_result = predict_diabetes_response(current_data)
            responses.append(prediction_result)
            current_data["waiting_for_more_questions"] = True
            current_data["current_question_index"] = 0
            current_data["current_symptoms"] = []
            return responses

        elif current_data.get("waiting_for_more_questions", False):
            if any(word in user_input_clean for word in positive_keywords):
                current_data["current_symptoms"].append(1)
            elif any(word in user_input_clean for word in negative_keywords):
                current_data["current_symptoms"].append(0)

            current_data["current_question_index"] += 1

            if current_data["current_question_index"] < len(questions):
                return questions[current_data["current_question_index"]]
            else:
                responses.append("ุณูุงูุงุช ุจู ูพุงุงู ุฑุณุฏ. ุฏุฑ ุญุงู ูุญุงุณุจู ูพุดโุจู ุฏููโุชุฑ...")

                # ุจูโุฑูุฒุฑุณุงู ูุณุช ููุง ุนูุงุฆู
                current_data["symptoms"] = current_data["current_symptoms"]

                # ุงูุฌุงู ูพุดโุจู
                final_prediction_result = predict_more_accurate_diabetes_response(current_data)
                responses.append(final_prediction_result)

                # ุฐุฎุฑู ุฏุงุฏู ุฏุฑ ูุงู ุจุนุฏ ุงุฒ ฺฉุงูู ุดุฏู ูพุงุณุฎโูุง
                final_probability = predict_diabetes(
                    np.array([[
                        current_data["age"],
                        current_data["gender"]
                    ] + current_data["current_symptoms"] + [0] * (14 - len(current_data["current_symptoms"]))])
                )

                save_user_data_as_row(user_id, current_data, final_probability)

                # ุบุฑูุนุงู ฺฉุฑุฏู ุญุงูุช ุณูุงูุงุช
                current_data["waiting_for_more_questions"] = False

                return responses

    if current_data["age"] is None:
        return "ูุทูุงู ุณู ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ."
    if current_data["gender"] is None:
        return "ูุทูุงู ุฌูุณุช ุฎูุฏ ุฑุง ูุดุฎุต ฺฉูุฏ (ุขูุง ุง ุฎุงูู) ู ุนูุงุฆูุชุงู ุฑุง ุจฺฏูุฏ."

    return " ".join(responses)
# ุชุงุจุน ูพุดโุจู ู ุงุฑุงุฆู ูุชุฌู  
def predict_diabetes_response(data):  
    age = data["age"]  
    gender = data["gender"]  
    symptoms = data["symptoms"]

    def has(symptom):
        return 1 if symptom in symptoms else 0

    input_features = np.array([[
        age,
        gender,
        has("ูพุฑุงุฏุฑุงุฑ"),
        has("ุนุทุด"),
        has("ฺฉุงูุด ูุฒู"),
        has("ุถุนู"),
        has("ูพุฑุฎูุฑ"),
        has("ุนูููุช ูุงุฑฺ"),
        has("ุชุงุฑ ุฏุฏ"),
        has("ุฎุงุฑุด"),
        has("ุนุตุจุงูุช"),
        has("ุชุฃุฎุฑ ุฏุฑ ุจูุจูุฏ"),
        has("ููุฌ ุฌุฒุฆ"),
        has("ุฏุฑุฏ ุนุถูุงู"),
        has("ุฑุฒุด ูู"),
        has("ฺุงู")
    ]])

    print(f"ูฺฺฏโูุง ูุฑูุฏ ุจุฑุง ูุฏู: {input_features}")
    probability = predict_diabetes(input_features)
    print(f"ุงุญุชูุงู ูพุดโุจู: {probability}")


    if probability > 50:
        return ("ุงุญุชูุงู ุงุจุชูุง ุจู ุฏุงุจุช ูุฌูุฏ ุฏุงุฑุฏ. ุงฺฏุฑ ูุงู ุจุงุดุฏ ูุชูุงูู ุจุง ูพุฑุณุด ฺูุฏ ุณูุงู ุงุญุชูุงู ุงุจุชูุง ุดูุง ุฑุง ุจู ุฏุงุจุช ุฏูู ุชุฑ ุจุฑุฑุณ ฺฉูู "
                "(ุฏุฑ ุตูุฑุช ุชูุงู ุจู ูพุฑุณุด ุณูุงูุงุช ฺฉููู 'ุณูุงู' ุฑุง ูุงุฑุฏ ฺฉูุฏ)")
    else:
        return (" ุงุญุชูุงู ุงุจุชูุง ุจู ุฏุงุจุช ูพุงู ุงุณุช. ุงฺฏุฑ ูุงู ุจุงุดุฏ ูุชูุงูู ุจุง ูพุฑุณุด ฺูุฏ ุณูุงู ุงุญุชูุงู ุงุจุชูุง ุดูุง ุฑุง ุจู ุฏุงุจุช ุฏูู ุชุฑ ุจุฑุฑุณ ฺฉูู"
                "(ุฏุฑ ุตูุฑุช ุชูุงู ุจู ูพุฑุณุด ุณูุงูุงุช ฺฉููู 'ุณูุงู' ุฑุง ูุงุฑุฏ ฺฉูุฏ)")

# ุฏุฑ ุชุงุจุน ุฌูุนโุขูุฑ ุงุทูุงุนุงุช  
def filter_nonnumeric(input_data):  
    # ููุท ููุงุฏุฑ ุนุฏุฏ ุฑุง ูฺฏู ูโุฏุงุฑู  
    return [value for value in input_data if isinstance(value, (int, float))]  

def predict_more_accurate_diabetes_response(data):  
    age = data.get("age")  # ุณู  
    gender = data.get("gender")  # 0 ุจุฑุง ุฎุงูู ู 1 ุจุฑุง ุขูุง  

    current_symptoms = data.get("current_symptoms", [])  # ุนูุงุฆู  
    print("Current symptoms:", current_symptoms)  # ฺุงูพ ุจุฑุง ุจุฑุฑุณ  

    # ุชุฑฺฉุจ ูฺฺฏโูุง  
    input_features = [age, gender] + current_symptoms  

    # ููุชุฑ ฺฉุฑุฏู ุนูุงุฆู ุบุฑ ุนุฏุฏ  
    filtered_input = filter_nonnumeric(input_features)  

    # ุจุฑุฑุณ ุชุนุฏุงุฏ ูฺฺฏโูุง  
    expected_features_count = 16  # ุชุนุฏุงุฏ ูฺฺฏโูุง ููุฑุฏ ุงูุชุธุงุฑ  
    actual_features_count = len(filtered_input)  
    print(f"Expected features: {expected_features_count}, Actual features: {actual_features_count}")  

    # ุงฺฏุฑ ุชุนุฏุงุฏ ูฺฺฏโูุง ฺฉูุชุฑ ุงุฒ ุญุฏ ุงูุชุธุงุฑ ุจุงุดุฏุ ุจุงุฏ ูุฑูุฏ ุฑุง ุงุตูุงุญ ฺฉูุฏ  
    if actual_features_count < expected_features_count:  
        # ูโุชูุงูุฏ ูฺฺฏโูุง ุงุถุงู ุฑุง ุจู ุตูุฑุช ุตูุฑ ุงุถุงูู ฺฉูุฏ  
        filtered_input += [0] * (expected_features_count - actual_features_count)  

    # ุชุจุฏู ูุณุช ุจู ุขุฑุงู NumPy ู ุชุบุฑ ุดฺฉู ุขู  
    input_array = np.array(filtered_input).reshape(1, -1)  
    # ุจุฑุฑุณ ุฏุฑุณุช ูุฑูุฏ ุจุฑุง ูุทูุฆู ุดุฏู ุงุฒ ุตุญุช ุขู  
    print("Input features for prediction:", input_array)  # ฺุงูพ ุจุฑุง ุจุฑุฑุณ  

    probability = predict_diabetes(input_array)  

    if probability > 50:  
        return ("<br>ุจุฑ ุงุณุงุณ ูพุงุณุฎ ุดูุง ุจู ุณูุงูุงุชุ ุงุญุชูุงู ุฏุงุจุช ูุฌูุฏ ุฏุงุฑุฏ."
               "ฺูุฏ ุชูุตู ุจุฑุง ุดูุง ุฏุงุฑู :<br>ูุทูุง ุฏุฑ ุงููู ูุฑุตุช ุจุง ูพุฒุดฺฉ ูุชุฎุตุต ูุดูุฑุช ฺฉูุฏ<br>"
               "ุขุฒูุงุดโูุง ุชุดุฎุต ฺฉุงููโุชุฑ ูุงุฒ ุงุณุช. ููฺฉู ุงุณุช ูุงุฒ ุจู ุฏุฑูุงู ุฏุงุฑู ุง ูพฺฏุฑ ูุฏุงูู ุฏุงุดุชู ุจุงุดุฏ.<br>"
               "ุฑฺู ุบุฐุง ุฎูุฏ ุฑุง ุงุตูุงุญ ฺฉูุฏุ ูุตุฑู ููุฏุ ููฺฉ ู ฺุฑุจ ุฑุง ฺฉุงูุด ุฏูุฏ.<br>"
               "ูุฑุฒุด ููุธู (ุญุฏุงูู ณฐ ุฏููู ุฏุฑ ุฑูุฒุ ต ุฑูุฒ ุฏุฑ ููุชู) ุฑุง ุดุฑูุน ุง ุญูุธ ฺฉูุฏ.<br>"
               "ุงฺฏุฑ ุณุงุจูู ุฎุงููุงุฏฺฏ ุจูุงุฑ ุฏุงุฑุฏุ ูุฑุงูุจ ุนูุงุฆู ูุดุฏุงุฑุฏููุฏู ุจุงุดุฏ ู ุจู ูฺ ุนููุงู ุชุบุฑุงุช ูุดฺฉูฺฉ ุฏุฑ ูุถุนุช ุณูุงูุช ุฑุง ูุงุฏุฏู ูฺฏุฑุฏ.")
    else:  
        return ("ุจุฑ ุงุณุงุณ ุงุทูุงุนุงุช ูุงุฑุฏ ุดุฏูุ ุงุญุชูุงู ุฏุงุจุช ูุฌูุฏ ูุฏุงุฑุฏ.<br>ูุถุนุช ุณูุงูุช ุดูุง ุฎูุจ ุงุณุช"
                "<br>ุณุจฺฉ ุฒูุฏฺฏ ุณุงูู ุฑุง ุญูุธ ฺฉูุฏุ ูุงููุฏ ุชุบุฐู ูุชุนุงุฏู ู ูุนุงูุช ุจุฏู ููุธู."
                "<br>ุจู ุทูุฑ ููุธู ฺฺฉุงูพ ุนููู ุงูุฌุงู ุฏูุฏ."
                "<br>ูุตุฑู ุฏุฎุงูุงุช ุฑุง ุจู ุญุฏุงูู ุจุฑุณุงูุฏ ุง ุชุฑฺฉ ฺฉูุฏ."
                "<br>ุงุณุชุฑุณ ุฎูุฏ ุฑุง ูุฏุฑุช ฺฉูุฏ ู ุฎูุงุจ ฺฉุงู ุฏุงุดุชู ุจุงุดุฏ.")  

def save_user_data_as_row(user_id, data, probability):
    file_path = "diabetes_user_data.csv"
    file_exists = os.path.isfile(file_path)

    symptom_list = list(symptom_keywords.keys())
    fieldnames = ["user_id", "age", "gender"] + symptom_list + ["prediction"]

    with open(file_path, mode="a", newline="", encoding="utf-8-sig") as file:
        writer = csv.DictWriter(file, fieldnames=fieldnames)

        if not file_exists:
            writer.writeheader()

        row = {
            "user_id": user_id,
            "age": data.get("age"),
            "gender": data.get("gender")
        }

        # ุจุฑุฑุณ ุงูฺฉู ุขุง ุนูุงุฆู ุจู ุตูุฑุช ุงุณู ูุณุชู ุง ููุท 0 ู 1
        if all(isinstance(val, int) for val in data.get("symptoms", [])):
            # ุงฺฏุฑ ุนูุงุฆู ุจู ุตูุฑุช ุตูุฑ ู ฺฉ ุจุงุดู (ูุซู ุจุนุฏ ุงุฒ ุณูุงูุงุช)
            symptom_values = data["symptoms"]
            for i, symptom in enumerate(symptom_list):
                row[symptom] = symptom_values[i] if i < len(symptom_values) else 0
        else:
            # ุงฺฏุฑ ุนูุงุฆู ุจู ุตูุฑุช ุงุณู ุจุงุดู (ูุซู ุงูู ูฺฉุงููู)
            for symptom in symptom_list:
                row[symptom] = 1 if symptom in data.get("symptoms", []) else 0

        row["prediction"] = 1 if probability > 50 else 0

        writer.writerow(row)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=False)


 
